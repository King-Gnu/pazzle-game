# 1 筆書きマスパズル - 仕様書

## 1. ゲーム概要

### 1.1 基本情報

- **ゲーム名**: 1 筆書きマスパズル
- **プラットフォーム**: Web ブラウザ（PC・スマートフォン対応）
- **技術スタック**: HTML5 Canvas, CSS3, Vanilla JavaScript

### 1.2 盤面構成

- n×n の正方形グリッド（6×6 ～ 10×10）
- 各マスは以下のいずれか：
  - **通行可能マス**（白）: 線を引ける
  - **お邪魔マス**（グレー、☒ 表示）: 通行不可

### 1.3 特殊マス

- **スタート（S）**: 緑色の丸、線の開始地点
- **ゴール（G）**: 赤色の丸、線の終了地点
- スタート・ゴールは必ず盤面の外周（端）に配置

## 2. ルール

### 2.1 目的

スタート（S）からゴール（G）まで、すべての白いマスを**1 回ずつ**、**途切れずに**通る 1 本の線を引く。

### 2.2 移動ルール

- 移動方向: **上下左右のみ**（斜め移動禁止）
- 同じマスを 2 回以上通ることは禁止
- 線の分岐・交差は禁止

### 2.3 クリア条件

以下をすべて満たした時にクリア：

1. ✅ スタートマス（S）から開始
2. ✅ ゴールマス（G）で終了
3. ✅ すべての白いマスを 1 回ずつ通過
4. ✅ 1 本の連続した線で接続
5. ✅ お邪魔マス（☒）を通っていない

## 3. UI・機能仕様

### 3.1 画面構成

```
┌─────────────────────────────────────┐
│        一筆書きマスパズル            │
│           [📖 ルール]               │
├─────────────────────────────────────┤
│ 盤面サイズ: [6×6 ▼]                 │
│ お邪魔マス数: [__] (最小:4/最大:34) │
│ [次の問題] [この設定で生成]         │
├─────────────────────────────────────┤
│ 難易度: 3.5 ████████░░░             │
├─────────────────────────────────────┤
│                                     │
│         ┌───────────────┐           │
│         │               │           │
│         │   盤面(Canvas)│           │
│         │               │           │
│         └───────────────┘           │
│                                     │
├─────────────────────────────────────┤
│   [リセット] [クリアルート表示]     │
│                                     │
│ [📋問題コードをコピー][📥問題コードを入力]│
└─────────────────────────────────────┘
```

### 3.2 コントロール

| 要素               | 機能                                       |
| ------------------ | ------------------------------------------ |
| 📖 ルール          | ルール説明モーダルを表示                   |
| 盤面サイズ         | 6×6, 7×7, 8×8, 9×9, 10×10 から選択         |
| お邪魔マス数       | サイズに応じた最小値～最大値の範囲で指定   |
| 次の問題           | お邪魔マス数をランダムに変更して新問題生成 |
| この設定で生成     | 現在のお邪魔マス数を維持して新問題生成     |
| リセット           | 描いた線をクリア（問題はそのまま）         |
| クリアルート表示   | 正解ルートをモーダルで表示                 |
| 問題コードをコピー | Base64 エンコードされた問題コードをコピー  |
| 問題コードを入力   | 問題コードを入力して盤面を再現             |

### 3.3 難易度表示

- スケール: 1.0 ～ 5.0
- 色: 緑（簡単）→ 黄 → オレンジ → 赤（難しい）
- 計算要素:
  - 盤面サイズ
  - お邪魔マス数
  - ルートの曲がり角数
  - 分岐ポイント数
  - お邪魔マスの連結成分数

### 3.4 モーダル一覧

| モーダル             | トリガー               | 内容                     |
| -------------------- | ---------------------- | ------------------------ |
| ルールモーダル       | 📖 ルールボタン        | ゲームルールの説明       |
| クリアルートモーダル | クリアルート表示ボタン | 正解経路の可視化         |
| 問題共有モーダル     | コピー/入力ボタン      | 問題コードのコピー・入力 |

## 4. 操作仕様

### 4.1 線の描画

| 操作           | PC                           | スマートフォン             |
| -------------- | ---------------------------- | -------------------------- |
| 線を引き始める | スタートをクリック＆ドラッグ | スタートをタッチ＆スワイプ |
| 線を引く       | マウスをドラッグ             | 指でなぞる                 |
| 一時停止       | マウスボタンを離す           | 指を離す                   |
| 続きを引く     | 終点からドラッグ再開         | 終点からタッチ再開         |
| 1 手戻し       | 直前のマスに戻る             | 直前のマスに戻る           |
| 途中から再開   | ルート上のマスをクリック     | ルート上のマスをタッチ     |

### 4.2 戻し操作の詳細

- 直前のマスに向かって移動すると、そのマスまで巻き戻し
- ルート上の任意のマスをクリック/タッチすると、そこまで巻き戻し
- スタートマスまで戻すことも可能

## 5. 問題生成アルゴリズム

### 5.1 生成戦略

問題生成は以下の 3 つの戦略を組み合わせて行う：

1. **経路優先方式（generateRandomPathPuzzle）**

   - グリーディウォークで経路を生成し、お邪魔マスを配置
   - 中央寄り配置を優先するスコアリング

2. **障害物先置き方式（generateObstacleFirstPuzzle）**

   - 先に障害物を中央寄りに配置
   - 連結性を確認後、ハミルトンパスを探索

3. **段階的緩和（relaxLevel 0-3）**
   - 外周制限: 70% → 85% → 100% → 120%
   - 連続配置許容数を段階的に増加

### 5.2 生成フロー

```
1. 経路優先方式（relaxLevel=0）で試行
2. 障害物先置き方式（relaxLevel=0）で試行
3. 制約を段階的に緩和（relaxLevel=1,2,3）しながら両方式を試行
4. 失敗時は障害物数を2ずつ減らして再試行（最低5%まで）
5. 最終保険: お邪魔マス0で生成
```

### 5.3 制約条件

- **連結性**: 通行可能マスが全て連結していること
- **外周配置**: スタート・ゴールは外周に配置
- **帯状回避**: 行/列の障害物連続を制限
- **中央配置**: お邪魔マスは中央寄りに配置を優先
- **外周制限**: 外周のお邪魔マス数を期待値の一定割合以下に制限

### 5.4 スコアリング要素

```javascript
score =
  branchEdges * 4 + // 分岐の多さ
  turns * 0.18 + // 曲がり角の多さ
  components * 0.8 + // お邪魔マスの分散度
  centralityBonus * 2.5 - // 中央配置ボーナス（障害物先置きは3.0）
  balancePenalty * 0.9 - // 偏りペナルティ
  runPenalty * 2.2 - // 連続配置ペナルティ
  outerPenalty * 3; // 外周配置ペナルティ
```

## 6. 問題共有仕様

### 6.1 エンコード形式

```
Base64(サイズ|お邪魔マス座標|スタート座標|ゴール座標)
```

### 6.2 データ形式

```
{size}|{y1},{x1};{y2},{x2};...|{sy},{sx}|{gy},{gx}
```

例: `6|2,3;3,2;4,4|0,2|5,3` → 6×6 盤面、お邪魔マス 3 個、S=(0,2)、G=(5,3)

## 7. レスポンシブ対応

### 7.1 ブレークポイント

- PC: 600px 以上
- スマートフォン: 600px 未満

### 7.2 スマホ対応

- タッチ操作のサポート
- `touch-action: none` でスクロール防止
- 盤面サイズを画面幅に合わせて自動調整
- ボタンを縦並びに配置

## 8. 数学的背景

### 8.1 オイラーパスの条件

この問題はグラフ理論の**オイラーパス**として定義される：

- すべての通行可能マスが連結していること
- スタートとゴールの次数が奇数
- その他すべてのマスの次数が偶数

### 8.2 市松模様条件

盤面を白黒の市松模様で塗ったとき：

- 通行可能マス数が**奇数** → スタートとゴールは**同じ色**
- 通行可能マス数が**偶数** → スタートとゴールは**異なる色**

## 9. ファイル構成

```
js_1line/
├── index.html          # HTML構造
├── style.css           # スタイル（レスポンシブ対応）
├── main.js             # ゲームロジック
├── README.md           # 概要説明
├── 仕様書.md           # この文書
├── .github/
│   └── workflows/
│       └── deploy.yml  # GitHub Actions
├── .gitignore
└── .nojekyll
```

## 10. 変更履歴

| 日付       | 変更内容                                                        |
| ---------- | --------------------------------------------------------------- |
| 2026/01/13 | 問題生成大幅改善（時間予算増加、分散配置、自動再生成）          |
| 2026/01/13 | 生成失敗時の表示・操作無効化、難易度欄にエラー表示              |
| 2026/01/13 | ダークテーマ実装（ローカルストレージで設定保存）                |
| 2026/01/09 | 問題生成アルゴリズム改善（段階的緩和、障害物先置き、動的調整）  |
| 2026/01/09 | 難易度計算を 0.0-5.0 スケールに変更、お邪魔マス 0 = 難易度 0.0  |
| 2026/01/09 | README.md と仕様書.md を現在の仕様に合わせて更新                |
| 2026/01/09 | ルールボタン・モーダル追加                                      |
| 2026/01/08 | お邪魔マスを中央寄りに配置するよう改善                          |
| 2026/01/08 | iPhone 対応の問題共有モーダル追加、「この設定で生成」ボタン追加 |
| 2026/01/08 | 難易度表示機能追加（1.0-5.0 スケール）、難易度バーの構造を修正  |
| 2026/01/08 | 問題共有機能追加（Base64 エンコード）                           |
| 2026/01/08 | クリア時のメッセージオーバーレイ追加                            |
| 2026/01/08 | スマートフォン対応（タッチ操作、レスポンシブデザイン）          |
| 2026/01/08 | 初版作成                                                        |
